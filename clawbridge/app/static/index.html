<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawBridge</title>
  <link rel="stylesheet" href="{{INGRESS_PATH}}/static/style.css">
</head>
<body>

<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 6l3-3 3 3"/>
          <path d="M12 3v8"/>
          <path d="M7 11l-2 2"/>
          <path d="M17 11l2 2"/>
          <path d="M4 17c0-2 2-4 8-4s8 2 8 4"/>
          <path d="M4 17v2h16v-2"/>
        </svg>
        ClawBridge
      </h1>
      <div class="subtitle">// guard rail for ai</div>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
        <svg class="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>

    <div class="sidebar-stats">
      <div class="stat-pills">
        <div class="stat-pill">
          <span class="stat-label">exposed</span>
          <span class="stat-value" id="exposed-count">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-mini"><span id="read-count">0</span> read</span>
          <span class="stat-mini stat-confirm"><span id="confirm-count">0</span> confirm</span>
          <span class="stat-mini stat-control"><span id="control-count">0</span> control</span>
        </div>
      </div>
    </div>

    <div class="domain-list" id="domain-list"></div>

    <div class="sidebar-footer">
      <button class="btn btn-save" onclick="saveSelection()" id="save-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save
      </button>
    </div>
  </aside>
  <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="closeSidebar()"></div>

  <!-- Main -->
  <main class="main">

    <!-- Tabs -->
    <div class="tabs">
      <button class="hamburger" id="sidebar-toggle" onclick="toggleSidebar()" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="tab-slider" id="tab-slider"></div>
      <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        dashboard
      </div>
      <div class="tab" data-tab="entities" onclick="switchTab('entities')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        entities
      </div>
      <div class="tab" data-tab="audit" onclick="switchTab('audit')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        audit
      </div>
      <div class="tab" data-tab="security" onclick="switchTab('security')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        security
      </div>
      <div class="tab" data-tab="settings" onclick="switchTab('settings')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
        settings
      </div>
      <div class="tab" data-tab="chat" onclick="switchTab('chat')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        chat
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="tab-dashboard">
      <div class="dashboard" id="dashboard-content">
        <div class="loading-overlay"><div class="spinner"></div><span>loading stats...</span></div>
      </div>
    </div>

    <!-- Entities Tab -->
    <div id="tab-entities" style="display:none;">
      <div class="toolbar">
        <div class="search-box">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="search-input" placeholder="search entities..." oninput="filterEntities()">
        </div>
        <button class="btn" onclick="selectAllVisible('read')">all read</button>
        <button class="btn" onclick="selectAllVisible('control')">all control</button>
        <button class="btn" onclick="deselectAllVisible()">deselect all</button>
      </div>
      <div class="entity-list" id="entity-list">
        <div class="loading-overlay" id="loading">
          <div class="spinner"></div>
          <span>loading entities...</span>
        </div>
      </div>
    </div>

    <!-- Audit Tab -->
    <div id="tab-audit" style="display:none;">
      <div class="toolbar">
        <span class="toolbar-label">ai action log</span>
        <div style="flex:1;"></div>
        <button class="btn" onclick="loadAuditLogs()">refresh</button>
        <button class="btn btn-danger" onclick="clearAuditLogs()">clear</button>
      </div>
      <div class="audit-list" id="audit-list">
        <div class="empty-state"><div class="empty-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><h3>No audit logs</h3><p>Service calls from AI agents will appear here.</p></div>
      </div>
    </div>

    <!-- Security Tab (API Keys + Schedules + Confirmation) -->
    <div id="tab-security" style="display:none;">
      <div class="security-panels">

        <!-- API Keys Section -->
        <div class="panel">
          <div class="panel-header">
            <h3>API Keys</h3>
            <button class="btn btn-primary btn-sm" onclick="showCreateKeyModal()">+ new key</button>
          </div>
          <div class="panel-body" id="api-keys-list">
            <div class="empty-state-sm">No API keys configured. All access is open.</div>
          </div>
        </div>

        <!-- Schedules Section -->
        <div class="panel">
          <div class="panel-header">
            <h3>Time Schedules</h3>
            <button class="btn btn-primary btn-sm" onclick="showCreateScheduleModal()">+ new schedule</button>
          </div>
          <div class="panel-body" id="schedules-list">
            <div class="empty-state-sm">No schedules configured. AI can act at any time.</div>
          </div>
        </div>

        <!-- Confirmation Section -->
        <div class="panel">
          <div class="panel-header">
            <h3>Pending Approvals</h3>
            <button class="btn btn-sm" onclick="loadPendingActions()">refresh</button>
          </div>
          <div class="panel-body" id="pending-actions-list">
            <div class="empty-state-sm">No pending actions.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" style="display:none;">
      <div class="settings-panel" id="settings-panel">
        <div class="settings-section">
          <h3>General</h3>
          <div class="setting-row">
            <div><div class="setting-label">Refresh Interval</div><div class="setting-desc">Seconds between state refreshes (1-3600)</div></div>
            <input type="number" class="number-input" id="setting-refresh" min="1" max="3600" value="5">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Filter Unavailable</div><div class="setting-desc">Exclude unavailable/unknown from endpoint</div></div>
            <label class="toggle"><input type="checkbox" id="setting-filter-unavailable" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Compact Mode</div><div class="setting-desc">Only entity_id + state (saves bandwidth)</div></div>
            <label class="toggle"><input type="checkbox" id="setting-compact"><span class="toggle-slider"></span></label>
          </div>
          <div class="setting-row">
            <div><div class="setting-label">AI Name</div><div class="setting-desc">Name shown in notifications (e.g. OpenClaw)</div></div>
            <input type="text" class="text-input" id="setting-ai-name" placeholder="AI" style="width:140px;">
          </div>
        </div>

        <div class="settings-section">
          <h3>Security</h3>
          <div class="setting-row">
            <div><div class="setting-label">Audit Logging</div><div class="setting-desc">Log all AI service calls</div></div>
            <label class="toggle"><input type="checkbox" id="setting-audit-enabled" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Audit Retention</div><div class="setting-desc">Days to keep audit logs (1-365)</div></div>
            <input type="number" class="number-input" id="setting-audit-retention" min="1" max="365" value="30">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Rate Limit</div><div class="setting-desc">Max service calls per minute per IP</div></div>
            <input type="number" class="number-input" id="setting-rate-limit" min="1" max="600" value="60">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">IP Allowlist</div><div class="setting-desc">Comma-separated IPs (empty = allow all)</div></div>
            <input type="text" class="text-input" id="setting-allowed-ips" placeholder="e.g. 192.168.1.50">
          </div>
        </div>

        <div class="settings-section">
          <h3>Human-in-the-Loop</h3>
          <div class="setting-row">
            <div><div class="setting-label">Confirmation Timeout</div><div class="setting-desc">Seconds to wait for human approval (10-600)</div></div>
            <input type="number" class="number-input" id="setting-confirm-timeout" min="10" max="600" value="120">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Notify Service</div><div class="setting-desc">HA notification service (e.g. notify.mobile_app_phone)</div></div>
            <input type="text" class="text-input" id="setting-confirm-notify" placeholder="notify.mobile_app_phone">
          </div>
        </div>

        <div class="settings-section">
          <h3>Chat / AI Gateway</h3>
          <div class="setting-row">
            <div><div class="setting-label">Gateway URL</div><div class="setting-desc">OpenClaw Gateway base URL (e.g. http://host:port)</div></div>
            <input type="text" class="text-input" id="setting-gateway-url" placeholder="http://localhost:8080">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Gateway Token</div><div class="setting-desc">Bearer token for gateway authentication</div></div>
            <input type="password" class="text-input" id="setting-gateway-token" placeholder="optional">
          </div>
          <div class="setting-row">
            <div><div class="setting-label">Test Connection</div><div class="setting-desc">Verify the gateway is reachable</div></div>
            <button class="btn btn-sm" onclick="testGatewayConnection()">test</button>
          </div>
        </div>

        <div class="settings-section">
          <h3>AI Endpoints</h3>
          <div class="endpoint-list">
            <div class="endpoint-item"><span class="endpoint-method get">GET</span><code>:8100/api/states</code></div>
            <div class="endpoint-item"><span class="endpoint-method post">POST</span><code>:8100/api/services/domain/service</code></div>
            <div class="endpoint-item"><span class="endpoint-method get">GET</span><code>:8100/api/websocket</code></div>
            <div class="endpoint-item"><span class="endpoint-method get">GET</span><code>:8100/api/history/period/{ts}</code></div>
            <div class="endpoint-item"><span class="endpoint-method get">GET</span><code>:8100/api/constraints</code></div>
            <div class="endpoint-item dim"><span class="endpoint-method get">GET</span><code>:8100/api/ai-sensors</code><span class="badge-legacy">legacy</span></div>
          </div>
        </div>

        <div class="settings-actions">
          <button class="btn btn-primary" onclick="saveSettings()">save settings</button>
          <button class="btn" onclick="exportConfig()">export</button>
          <button class="btn" onclick="document.getElementById('import-file').click()">import</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importConfig(event)">
        </div>

        <!-- Presets subsection -->
        <div class="settings-section">
          <div class="panel-header">
            <h3>Presets</h3>
            <button class="btn btn-primary btn-sm" onclick="showSavePresetModal()">+ save preset</button>
          </div>
          <div id="preset-list"></div>
        </div>
      </div>
    </div>

    <!-- Chat Tab -->
    <div id="tab-chat" style="display:none;">
      <div class="chat-container">
        <div class="chat-header">
          <span class="chat-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            AI Chat
          </span>
          <div class="chat-header-actions">
            <span class="chat-status" id="chat-status">not configured</span>
            <button class="btn btn-sm" onclick="clearChatHistory()" title="New conversation">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              new
            </button>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-empty" id="chat-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <p>Start a conversation with your AI</p>
            <p class="chat-empty-hint">Configure the Gateway URL in Settings first</p>
          </div>
        </div>
        <div class="chat-input-bar">
          <textarea id="chat-input" placeholder="Type a message..." rows="1" onkeydown="handleChatKeydown(event)" oninput="autoResizeChatInput()"></textarea>
          <button class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()" title="Send">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Bottom Status Bar -->
<div class="status-dock" id="status-dock">
  <div class="dock-left">
    <span class="status-indicator">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">connecting...</span>
    </span>
    <span class="dock-divider"></span>
    <span id="status-domain" class="dock-domain">-</span>
  </div>
  <div class="dock-center">
    <span class="dock-pill read"><span id="dock-read">0</span> read</span>
    <span class="dock-pill confirm"><span id="dock-confirm">0</span> confirm</span>
    <span class="dock-pill control"><span id="dock-control">0</span> control</span>
  </div>
  <div class="dock-right">
    <span id="status-filter"></span>
    <span class="dock-divider"></span>
    <span id="status-ws" class="ws-badge">WS</span>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="preset-modal">
  <div class="modal">
    <h3>Save Preset</h3>
    <input type="text" id="preset-name-input" placeholder="preset name...">
    <div class="modal-actions">
      <button class="btn" onclick="hidePresetModal()">cancel</button>
      <button class="btn btn-primary" onclick="savePreset()">save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="sensitive-modal">
  <div class="modal">
    <h3 class="modal-warning">Security Warning</h3>
    <p id="sensitive-modal-text" class="modal-text"></p>
    <label class="modal-check">
      <input type="checkbox" id="sensitive-confirm-check">
      I understand the security implications
    </label>
    <div class="modal-actions">
      <button class="btn" onclick="cancelSensitiveModal()">cancel</button>
      <button class="btn btn-primary" id="sensitive-confirm-btn" onclick="confirmSensitiveModal()" disabled>confirm</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="key-modal">
  <div class="modal">
    <h3>Create API Key</h3>
    <input type="text" id="key-name-input" placeholder="key name (e.g. OpenClaw)">
    <div class="modal-actions">
      <button class="btn" onclick="hideKeyModal()">cancel</button>
      <button class="btn btn-primary" onclick="createApiKey()">create</button>
    </div>
    <div id="key-result" class="key-result" style="display:none;"></div>
  </div>
</div>

<div class="modal-overlay" id="schedule-modal">
  <div class="modal">
    <h3>Create Schedule</h3>
    <input type="text" id="schedule-name-input" placeholder="schedule name (e.g. Daytime)">
    <div class="schedule-time-row">
      <label>Start <input type="time" id="schedule-start" value="06:00"></label>
      <label>End <input type="time" id="schedule-end" value="23:00"></label>
    </div>
    <div class="schedule-days" id="schedule-days">
      <label><input type="checkbox" value="0" checked> Mon</label>
      <label><input type="checkbox" value="1" checked> Tue</label>
      <label><input type="checkbox" value="2" checked> Wed</label>
      <label><input type="checkbox" value="3" checked> Thu</label>
      <label><input type="checkbox" value="4" checked> Fri</label>
      <label><input type="checkbox" value="5" checked> Sat</label>
      <label><input type="checkbox" value="6" checked> Sun</label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="hideScheduleModal()">cancel</button>
      <button class="btn btn-primary" onclick="createSchedule()">create</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="annotation-modal">
  <div class="modal">
    <h3>Entity Description</h3>
    <p id="annotation-entity-id" class="modal-text"></p>
    <textarea id="annotation-text" placeholder="Describe this entity for the AI (e.g. Main ceiling light in the home office, 2nd floor)" rows="3"></textarea>
    <div class="modal-actions">
      <button class="btn" onclick="hideAnnotationModal()">cancel</button>
      <button class="btn btn-primary" onclick="saveAnnotation()">save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="constraints-modal">
  <div class="modal">
    <h3>Parameter Constraints</h3>
    <p id="constraints-entity-id" class="modal-text"></p>
    <div id="constraints-editor"></div>
    <div class="modal-actions">
      <button class="btn" onclick="hideConstraintsModal()">cancel</button>
      <button class="btn btn-primary" onclick="saveConstraintsFromModal()">save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="{{INGRESS_PATH}}/static/app.js"></script>
</body>
</html>
